# 원본 → 통합 데이터 병합

## 목적

원본 엑셀들을 **DB별 통합 CSV**로 모음

---

## 1) 원본 통합(merge) – 공통 규칙

대상: **마켓DB / 법인DB / 인허가DB / 포털DB**

* **스캔**

  * `ROOT_DIR` 하위의 **지역 폴더**(예: `서울/부산/...`)를 순회
  * 각 지역 폴더의 `*.xlsx` 중 파일명에 DB명이 포함된 파일만 선택

* **로드/최소 전처리**

  * 첫 시트만 `dtype=str` 로드, 문자열 `strip()` (공백만 있으면 `None`)
  * 파일마다 메타 컬럼 추가

    * `region` = 상위 폴더명
    * `source_db` = 해당 DB명
  * **수직 결합**(`pd.concat`) 후 **완전 빈 행만 제거**(`dropna(how="all")`)

* **merchant\_code 부여**

  * 접두사: `마켓=M`, `법인=B`, `인허가=L`, `포털=P`
  * 형식: `M0000001`(7자리 zero-pad 연번)
  * 기존 `merchant_code`가 있으면 삭제 후 재생성

* **저장(결측=빈문자)**

  * `<DB명>_merged.utf8.csv` (UTF-8 with BOM)
  * `<DB명>_merged.csv` (CP949)

> 이 단계는 **메타만 붙여 모으는 작업**으로 한정.

---

## 2) 원본 통합(merge) – **기업DB** 규칙

* **스캔**

  * 보통 단일 폴더(`./기업DB`)에서 `*.xlsx` 로드

* **업종 컬럼 생성**

  * **파일명에서 업종 토큰 추출** → `업종` 컬럼에 세팅
    예) `커피_2024-03.xlsx` → `업종="커피"`
    `_`가 없으면 파일명(stem) 자체를 업종으로 사용
  * 기존 `업종`이 있어도 **파일명 기반 값으로 덮어씀**

* **메타 컬럼**

  * `source_db = "기업DB"`
  * `region`은 **이 단계에선 미생성**(기업DB는 지역 폴더 구조가 없으므로)
    → **스테이징에서 주소로부터 region 추론**

* **merchant\_code 부여**

  * 접두사: `C`, 형식: `C0000001` 연번

* **저장(두 트랙)**

  1. 통합본(merchant\_code 포함):
     `기업DB_merged.utf8.csv`, `기업DB_merged.csv`
  2. **원본 파일별 + merchant\_code 부착본**:
     `_merged_csv/기업DB_by_file/<원본파일명>_with_code.(utf8/cp949).csv`
     *(원본 엑셀은 수정하지 않고 보존)*
